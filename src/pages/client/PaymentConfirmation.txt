// src/pages/client/PaymentConfirmation.tsx
import { useEffect, useState } from 'react';
import { useLocation, useNavigate, Link } from 'react-router-dom';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { CheckCircle, Download, ArrowLeft, Calendar, User, MapPin } from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';
import { generateInvoice } from '@/utils/pdfGenerator';
import { appState } from '@/utils/mockData';

const PaymentConfirmation = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const { user } = useAuth();
  const [booking, setBooking] = useState<any>(null);
  const [worker, setWorker] = useState<any>(null);

  useEffect(() => {
    // Obtener datos del pago desde el estado de navegación o parámetros
    const paymentData = location.state?.paymentData;
    
    if (!paymentData) {
      navigate('/client/dashboard');
      return;
    }

    const foundBooking = appState.bookings.find(b => b.id === paymentData.bookingId);
    const foundWorker = appState.workers.find(w => w.id === foundBooking?.workerId);

    if (foundBooking && foundWorker) {
      setBooking(foundBooking);
      setWorker(foundWorker);
    } else {
      navigate('/client/dashboard');
    }
  }, [location, navigate]);

  const handleDownloadInvoice = () => {
    if (booking && worker && user) {
      generateInvoice({
        bookingId: booking.id,
        clientName: user.name,
        workerName: worker.name,
        workerBusiness: worker.businessName || worker.commercialName || worker.name,
        workerRUT: '76.123.456-7',
        serviceType: booking.serviceType,
        date: booking.date,
        price: booking.price,
        address: booking.address
      });
    }
  };

  if (!booking || !worker) {
    return <div>Cargando...</div>;
  }

  return (
    <div className="min-h-screen bg-gradient-subtle flex items-center justify-center p-4">
      <div className="w-full max-w-2xl">
        <Card className="border-green-200">
          <CardHeader className="text-center pb-4">
            <div className="flex justify-center mb-4">
              <CheckCircle className="h-16 w-16 text-green-500" />
            </div>
            <CardTitle className="text-2xl text-green-700">
              ¡Pago Confirmado!
            </CardTitle>
            <p className="text-muted-foreground mt-2">
              Tu reserva ha sido confirmada exitosamente
            </p>
          </CardHeader>

          <CardContent className="space-y-6">
            {/* Resumen de la reserva */}
            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
              <h3 className="font-semibold text-green-800 mb-3">Resumen de tu reserva</h3>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div className="flex items-center gap-2">
                  <User className="h-4 w-4 text-green-600" />
                  <span className="font-medium">Trabajador:</span>
                  <span>{worker.name}</span>
                </div>
                
                <div className="flex items-center gap-2">
                  <Calendar className="h-4 w-4 text-green-600" />
                  <span className="font-medium">Fecha:</span>
                  <span>{new Date(booking.date).toLocaleDateString('es-CL')}</span>
                </div>
                
                <div className="flex items-center gap-2">
                  <MapPin className="h-4 w-4 text-green-600" />
                  <span className="font-medium">Dirección:</span>
                  <span>{booking.address}</span>
                </div>
                
                <div className="flex items-center gap-2">
                  <span className="font-medium">Servicio:</span>
                  <span className="capitalize">{booking.serviceType.replace('_', ' ')}</span>
                </div>
                
                <div className="flex items-center gap-2">
                  <span className="font-medium">Horario:</span>
                  <span>{booking.timeSlot.startTime} - {booking.timeSlot.endTime}</span>
                </div>
                
                <div className="flex items-center gap-2">
                  <span className="font-medium">Total pagado:</span>
                  <span className="font-bold text-green-700">
                    ${booking.price.toLocaleString('es-CL')}
                  </span>
                </div>
              </div>
            </div>

            {/* Próximos pasos */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h3 className="font-semibold text-blue-800 mb-2">Próximos pasos</h3>
              <ul className="text-sm text-blue-700 space-y-1">
                <li>• El trabajador ha sido notificado de tu reserva</li>
                <li>• Recibirás un recordatorio 24 horas antes del servicio</li>
                <li>• Puedes contactar al trabajador si necesitas hacer cambios</li>
                <li>• Califica el servicio después de completado</li>
              </ul>
            </div>

            {/* Acciones */}
            <div className="flex flex-col sm:flex-row gap-3 justify-center">
              <Button 
                onClick={handleDownloadInvoice}
                className="bg-green-600 hover:bg-green-700"
              >
                <Download className="h-4 w-4 mr-2" />
                Descargar Boleta PDF
              </Button>
              
              <Link to="/client/bookings">
                <Button variant="outline">
                  <Calendar className="h-4 w-4 mr-2" />
                  Ver Mis Reservas
                </Button>
              </Link>
              
              <Link to="/client/dashboard">
                <Button variant="ghost">
                  <ArrowLeft className="h-4 w-4 mr-2" />
                  Volver al Inicio
                </Button>
              </Link>
            </div>

            {/* Información adicional */}
            <div className="text-center text-xs text-muted-foreground">
              <p>¿Necesitas ayuda? Contacta a soporte@casalimpia.cl</p>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
};

export default PaymentConfirmation;